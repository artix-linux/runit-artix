#!/bin/bash

. @RCLIBDIR@/functions

HWCLOCK_PARAMS="--systz"
HARDWARECLOCK=${HARDWARECLOCK:-'UTC'}

[[ -f /etc/adjtime ]] && { read ; read ; read ADJTIME; } < /etc/adjtime

if [[ $ADJTIME == 'LOCAL' ]]; then
    if	[[ $HARDWARECLOCK == 'UTC' ]]; then
        printf "${C_FAIL}/etc/rc.conf says the RTC is in UTC, but /etc/adjtime says it is in localtime.\n${C_OTHER}."
    fi
else
    if [[ $HARDWARECLOCK == 'LOCALTIME' ]]; then
        printf "${C_FAIL}/etc/rc.conf says the RTC is in localtime, but hwclock (/etc/adjtime) thinks it is in UTC.\n${C_OTHER}."
    fi
fi

case $HARDWARECLOCK in
    UTC) HWCLOCK_PARAMS+=" --utc --noadjfile";;
    localtime) HWCLOCK_PARAMS+=" --localtime --noadjfile";;
    *) HWCLOCK_PARAMS="";;
esac

case "$1" in
    start)
        hwclock $HWCLOCK_PARAMS || stat_die
        add_daemon hwclock;;
    stop)
        hwclock --adjust $HWCLOCK_PARAMS
        rm_daemon hwclock
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    *)
        echo "usage: $0 {start|stop|restart}"
        ;;
esac
